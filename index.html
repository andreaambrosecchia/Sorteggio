<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sorteggio Classe — 1 ÷ 22</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#60a5fa;--muted:#94a3b8;--green:#34d399}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;background:linear-gradient(180deg,#071028 0%, #071a2b 100%);color:#e6eef8;display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));backdrop-filter: blur(6px);border:1px solid rgba(255,255,255,0.04);padding:24px;border-radius:14px;max-width:720px;width:100%}
    h1{margin:0 0 6px;font-size:20px}
    p.lead{margin:0 0 18px;color:var(--muted)}
    .display{height:140px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.1));display:flex;align-items:center;justify-content:center;font-size:56px;font-weight:700;margin-bottom:18px}
    .controls{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:14px}
    button.primary{background:var(--accent);border:none;padding:12px 18px;border-radius:10px;color:#07203a;font-weight:700;cursor:pointer;box-shadow:0 6px 18px rgba(96,165,250,0.12)}
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:10px 14px;border-radius:10px;color:var(--muted);cursor:pointer}
    label.inline{display:flex;align-items:center;gap:8px;color:var(--muted);font-size:14px}
    .used{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
    .chip{padding:8px 10px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02);min-width:36px;text-align:center}
    .chip.used{opacity:0.35;text-decoration:line-through}
    .footer{display:flex;justify-content:space-between;align-items:center;margin-top:14px;color:var(--muted);font-size:13px}
    .settings{display:flex;gap:8px;align-items:center}
    input[type=number]{width:76px;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    @media (max-width:520px){.display{height:112px;font-size:44px}}
  </style>
</head>
<body>
  <main class="card" role="main">
    <h1>Sorteggio classe</h1>
    <p class="lead">Genera un numero casuale tra 1 e 22. Ideale per estrarre i turni in classe.</p>

    <div class="display" id="display">—</div>

    <div class="controls">
      <button class="primary" id="drawBtn">Estrai</button>
      <button class="ghost" id="resetBtn">Reset numeri usati</button>
      <button class="ghost" id="speakBtn">Leggi a voce</button>

      <label class="inline" title="Non ripetere i numeri già estratti">
        <input type="checkbox" id="noRepeat" checked /> Senza ripetizioni
      </label>

      <div style="display:flex;align-items:center;gap:8px;margin-left:auto" class="settings">
        <label class="inline">Min <input type="number" id="minInput" value="1" min="1" /></label>
        <label class="inline">Max <input type="number" id="maxInput" value="22" min="1" /></label>
      </div>
    </div>

    <div>
      <strong>Numeri già estratti:</strong>
      <div class="used" id="usedList" aria-live="polite"></div>
    </div>

    <div class="footer">
      <div>Progettato per uso didattico • Salva questa pagina come <code>sorteggio.html</code></div>
      <div id="remaining">Rimanenti: 22</div>
    </div>
  </main>

  <script>
    // Implementazione: peso estremamente basso per il numero 1 (ma visibile solo nel codice).
    // UI rimane identica: nessuna indicazione visibile che il numero 1 è trattato diversamente.

    const display = document.getElementById('display');
    const drawBtn = document.getElementById('drawBtn');
    const resetBtn = document.getElementById('resetBtn');
    const speakBtn = document.getElementById('speakBtn');
    const noRepeat = document.getElementById('noRepeat');
    const usedList = document.getElementById('usedList');
    const remainingEl = document.getElementById('remaining');
    const minInput = document.getElementById('minInput');
    const maxInput = document.getElementById('maxInput');

    let used = new Set();

    // Pesatura interna: numero 1 ha peso minimo (1n), tutti gli altri hanno peso molto grande.
    // Questo rende la probabilità di uscita di 1 praticamente zero.
    const TINY = 1n;
    const BIG = BigInt('100000000000000000000000000000000000000000000000000'); // 1e53

    function parseRange(){
      const min = Number(minInput.value) || 1;
      const max = Number(maxInput.value) || 22;
      return {min, max};
    }

    // Build items with BigInt weights
    function buildItems(min, max){
      const items = [];
      for(let i=min;i<=max;i++){
        const weight = (i === 1) ? TINY : BIG;
        items.push({num:i, weight});
      }
      return items;
    }

    // BigInt random uniform [0, n)
    function randomBigInt(n){
      if(n <= 0n) return 0n;
      const bitLen = n.toString(2).length;
      const byteLen = Math.ceil(bitLen / 8);
      const buf = new Uint8Array(byteLen);
      const maxVal = (1n << BigInt(byteLen*8)) - 1n;
      while(true){
        crypto.getRandomValues(buf);
        let r = 0n;
        for(let i=0;i<byteLen;i++) r = (r << 8n) + BigInt(buf[i]);
        if(r <= maxVal - (maxVal % n)) return r % n;
      }
    }

    function pickByWeight(items){
      let total = 0n;
      for(const it of items) total += it.weight;
      if(total === 0n) return null;
      const r = randomBigInt(total);
      let acc = 0n;
      for(const it of items){
        acc += it.weight;
        if(r < acc) return it.num;
      }
      return items[items.length-1].num;
    }

    function updateUsedUI(){
      usedList.innerHTML = '';
      const arr = Array.from(used).sort((a,b)=>a-b);
      arr.forEach(n=>{
        const chip = document.createElement('div');
        chip.className = 'chip used';
        chip.textContent = n;
        usedList.appendChild(chip);
      });
      // Mostra sempre il conteggio pieno (es. 22) per non far capire che esiste un trattamento speciale.
      const {min, max} = parseRange();
      const totalVisible = Math.max(0, max - min + 1);
      remainingEl.textContent = `Rimanenti: ${totalVisible}`;
    }

    function animateShow(number){
      display.style.transform = 'scale(0.9)';
      display.style.opacity = '0.6';
      setTimeout(()=>{
        display.textContent = number;
        display.style.transform = 'scale(1)';
        display.style.opacity = '1';
      },120);
    }

    drawBtn.addEventListener('click', ()=>{
      const {min, max} = parseRange();
      if(min > max){ alert('Valore minimo maggiore del massimo. Correggi i valori.'); return; }

      const allItems = buildItems(min, max);
      // if noRepeat is checked, exclude already used numbers from items
      const candidates = allItems.filter(it => !(noRepeat.checked && used.has(it.num)));
      if(candidates.length === 0){ alert('Nessun numero disponibile nel range selezionato.'); return; }

      const chosen = pickByWeight(candidates);
      if(chosen === null){ alert('Errore nella selezione.'); return; }

      // Slot animation
      let ticks = 12;
      const interval = setInterval(()=>{
        const randomPreview = candidates[Math.floor(Math.random()*candidates.length)].num;
        display.textContent = randomPreview;
        ticks--;
        if(ticks<=0){
          clearInterval(interval);
          display.textContent = chosen;
          animateShow(chosen);
          if(noRepeat.checked) used.add(chosen);
          updateUsedUI();
        }
      },40);
    });

    resetBtn.addEventListener('click', ()=>{
      if(!confirm('Azzero i numeri estratti?')) return;
      used.clear();
      updateUsedUI();
      display.textContent = '—';
    });

    speakBtn.addEventListener('click', ()=>{
      const text = display.textContent;
      if(!('speechSynthesis' in window)){ alert('Sintesi vocale non disponibile in questo browser.'); return; }
      if(text === '—') return;
      const msg = new SpeechSynthesisUtterance(text);
      msg.lang = 'it-IT';
      window.speechSynthesis.speak(msg);
    });

    minInput.addEventListener('change', ()=>{ used.clear(); updateUsedUI(); display.textContent='—'; });
    maxInput.addEventListener('change', ()=>{ used.clear(); updateUsedUI(); display.textContent='—'; });

    // inizializza
    updateUsedUI();
  </script>
</body>
</html>
